---
- name: >
    {{ testname }} - Check if external secrets object in
    {{ project }}-{{ branch }} namespace exists
  shell: |
    set -e
    kubectl -n {{ project }}-{{ branch }} get secret lagoon-external-secrets
  register: result
  until: result.rc == 0
  retries: 10
  delay: 30
- name: >
    {{ testname }} - Check if external secrets object in
    {{ project }}-{{ branch }} namespace exists
  debug: msg="Success!!!"

- name: >
    {{ testname }} - Check if external secrets object in
    {{ project }}-{{ branch }} namespace contains the expected data
  shell: >
    set -e;
    kubectl -n {{ project }}-{{ branch }} get secret
    lagoon-external-secrets -o json
    | jq -e '(.data.EXTERNAL_SECRET_MOCK_SECRET_BAR | @base64d) == "bar"
    and (.data.EXTERNAL_SECRET_MOCK_SECRET_FOO | @base64d) == "foo"'
- name: >
    {{ testname }} - Check if external secrets object in
    {{ project }}-{{ branch }} namespace contains the expected data
  debug: msg="Success!!!"
